<html>
<head>
    <style>
        table {width: 100%; font-size: min(2.5vw, 22px); border-collapse: collapse; margin-bottom: 20px;}
        table tr td {text-align: center;}
        tr[data-clubId="1442"/* TuS Neuk√∂lln */] {background: #ffff80;}
        span {color: gray;}
        @media (min-width: 1000px) {table {max-width: 900px;}}
    </style>
<head>
<body>
    <h1>Loading...</h1> 
    <table border='1'>
        <tr><th>#</th><th>Name</th><th>Games</th><th>Wins</th><th>Win%</th><th>Points</th></tr>
    </table>
    [<a href='https://github.com/madmaxmatze/bball' target='_blank'>code</a>]
</body>
</html>

<script>
function getLeagueId() {
    return parseInt((new URLSearchParams(location.search)).get('id')) || 38428;
}

async function loadData(leagueID) {
    var json = JSON.parse(localStorage.getItem('basketballData' + leagueID));
    if (json && (new Date() - new Date(json.timestamp)) < 10 * 60 * 1000) {
        return json.data;
    }

    return fetch('https://api.codetabs.com/v1/proxy/?quest=https://www.basketball-bund.net/rest/competition/crosstable/id/' + leagueID) // CORS proxy: https://codetabs.com/cors-proxy/cors-proxy.html
        .then(response => response.json())
        .then(json => {
            localStorage.setItem('basketballData' + leagueID, JSON.stringify(json));
            return json.data;
        });
}

function processData(data) {
    data.tabelle = data.kreuztabelle.crossTableEntries
        .reduce((teamsArray, item) => {
            teamsArray[item.team.seasonTeamId] = {matches:item.matches, info:item.team, games:0, wins:0, pointsHome:0, pointsGuest:0, comments:[]};
            return teamsArray;
        }, [])
        .filter((homeTeam, _index, teamsArray) => 
            homeTeam.matches.filter(match => match).flat().filter(match => {
                var guestTeam = teamsArray[match.guestTeam.seasonTeamId];
                var comment = `${match.kickoffDate} | ${homeTeam.info.teamnameSmall} ${match.result || "__:__"} ${guestTeam.info.teamnameSmall}`;
                homeTeam.comments.push(comment);
                guestTeam.comments.push(comment);
                if (match.result) {
                    var [homeResult, guestResult] = match.result.split(':').map(Number);
                    homeTeam.games++;
                    homeTeam.pointsHome += homeResult;
                    homeTeam.pointsGuest += guestResult;
                    guestTeam.games++;
                    guestTeam.pointsHome += guestResult;
                    guestTeam.pointsGuest += homeResult;
                    var [winningTeam, loosingTeam] = [homeTeam, guestTeam].sort(() => homeResult - guestResult);
                    winningTeam.wins++;
                    winningTeam.comments[winningTeam.comments.length - 1] += " >> WIN";
                }
            })
        )
        .filter(team => Object.assign(team, {
            perc: Math.round(team.games ? team.wins / team.games * 100 : 0),
            pointsDiff: team.pointsHome - team.pointsGuest
        }))
        .sort((teamA, teamB) => teamB.perc - teamA.perc || teamB.pointsDiff - teamA.pointsDiff);
    return data;
}

function outputData(data) {
    document.querySelector("h1").innerHTML = `<a href='https://www.basketball-bund.net/static/#/liga/${data.ligaData.ligaId}/kreuztabelle'>${data.ligaData.liganame} - ${data.ligaData.seasonName}</a>`;
    data.tabelle.forEach((team, i) => {
        document.querySelector("table").innerHTML += `<tr data-clubId='${team.info.clubId}'>
            <th>${i + 1}</th>
            <td>${team.info.teamname}</td>
            <td>${team.games}</td>
            <td>${team.wins}</td>
            <td>${team.perc}%</td>
            <td title='${team.comments.sort().join("\n")}'>${("+"+team.pointsDiff).replace("+-", "-")} <span>(${team.pointsHome}:${team.pointsGuest})</span></td>
        </tr>`;
    });
}

function handleErrors(error) {
    console.error(error);
    document.querySelector("table").outerHTML = "<h2 style='color:red'>ERROR occured</h2>";
}

loadData(getLeagueId())
    .then(processData)
    .then(outputData)
    .catch(handleErrors);
</script>

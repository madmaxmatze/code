<html>
<head>
    <style>
        table {width: 100%; font-size: min(2.5vw, 22px); border-collapse: collapse; margin-bottom: 20px;}
        table tr td {text-align: center;}
        tr[data-clubId="1442"/* TuS Neuk√∂lln */] {background: #ffff80;}
        span {color: gray;}
        @media (min-width: 1000px) {table {max-width: 900px;}}
    </style>
<head>
<body>
    <h1>Loading...</h1> 
    <table border='1'>
        <tr><th>#</th><th>Name</th><th>Games</th><th>Wins</th><th>Win%</th><th>Points</th></tr>
    </table>
    [<a href='https://github.com/madmaxmatze/bball' target='_blank'>code</a>]
</body>
</html>

<script>
function getLeagueParam() {
    return parseInt((new URLSearchParams(location.search)).get('id')) || 38428;
}

async function loadData(leagueID) {
    var json = JSON.parse(localStorage.getItem('basketballData' + leagueID));
    
    if (!json || (new Date() - new Date(json.timestamp)) / 1000 > 3600) { // older 1h
        var response = await fetch('https://api.codetabs.com/v1/proxy/?quest=https://www.basketball-bund.net/rest/competition/crosstable/id/' + leagueID); // CORS proxy: https://codetabs.com/cors-proxy/cors-proxy.html
        json = await response.json();
        if (json.data) {
            localStorage.setItem('basketballData' + leagueID, JSON.stringify(json));
        }
    }

    return json.data;
}

function prepareData(data) {
    data.tabelle = data.kreuztabelle.crossTableEntries
        .reduce((array, item) => {
            array[item.team.seasonTeamId] = {...item, ...{games:0, wins:0, pointsHome:0, pointsGuest:0, gameComment:[]}};
            return array;
        }, [])
        .filter((homeTeam, index, array) => 
            homeTeam.matches.filter(match => match?.[0]?.result).filter(match => {
                var guestTeam = array[match[0].guestTeam.seasonTeamId];
                var [homeResult, guestResult] = match[0].result.split(':').map(i => parseInt(i));
                var gameComment = `${match[0].kickoffDate} | ${homeTeam.team.teamnameSmall} ${homeResult}:${guestResult} ${guestTeam.team.teamnameSmall}`;
                var [winningTeam, loosingTeam] = [homeTeam, guestTeam].sort(() => (homeResult - guestResult));
                winningTeam.wins++;
                homeTeam.games++;
                guestTeam.games++;
                homeTeam.pointsHome += homeResult;
                homeTeam.pointsGuest += guestResult;
                guestTeam.pointsHome += guestResult;
                guestTeam.pointsGuest += homeResult;
                winningTeam.gameComment.push(gameComment + " >> WIN");
                loosingTeam.gameComment.push(gameComment);
            })
        )
        .filter(item => Object.assign(item, {
            perc: Math.round((item.games ? item.wins / item.games : 0) * 100),
            pointsDiff: item.pointsHome - item.pointsGuest
        }))
        .sort((a, b) => (a.perc == b.perc ? b.pointsDiff - a.pointsDiff : b.perc - a.perc));
    return data;
}

function outputData(data) {
    document.querySelector("h1").innerHTML = `<a href='https://www.basketball-bund.net/static/#/liga/${data.ligaData.ligaId}/kreuztabelle'>${data.ligaData.liganame} - ${data.ligaData.seasonName}</a>`;
    data.tabelle.forEach((item, i) => {
        document.querySelector("table").innerHTML += `<tr data-clubId='${item.team.clubId}'>
            <th>${i + 1}</th>
            <td>${item.team.teamname}</td>
            <td>${item.games}</td>
            <td>${item.wins}</td>
            <td>${item.perc}%</td>
            <td title='${item.gameComment.sort().join("\n")}'>${item.pointsDiff > 0 ? "+" : ""}${item.pointsDiff} <span>(${item.pointsHome}:${item.pointsGuest})</span></td>
        </tr>`;
    });
}

function handleErrors(error) {
    console.error(error);
    document.querySelector("table").outerHTML = "<h2 style='color:red'>ERROR occured</h2>";
}

loadData(getLeagueParam())
    .then(prepareData)
    .then(outputData)
    .catch(handleErrors);
</script>

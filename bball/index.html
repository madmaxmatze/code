<!DOCTYPE html><html>
<head>
<style>
  table {width: 100%; font-size: min(2.5vw, 22px); border-collapse: collapse; margin-bottom: 20px;}
  table tr td {text-align: center;}
  tr[data-clubId="1442"/* TuS Neuk√∂lln */] {background: #ffff80;}
  span {color: gray;}
  @media (min-width: 1000px) {table {max-width: 900px;}}
</style>
<script>
  const getDataUrl = async () => (
    /* CORSproxy */ "https://api.codetabs.com/v1/proxy/?quest=" +
    /* leagueUrl */ "https://www.basketball-bund.net/rest/competition/crosstable/id/" +
    /* leagueID  */ parseInt((new URLSearchParams(location.search)).get('id') || 38428) +
    /* caching   */ "?cacheInvalidation=" + Math.round(Date.now() / 1000 / 60 / 10/*min*/)
  );

  const loadData = async (dataUrl) => (
    await fetch(dataUrl, {"cache": "force-cache"}).then(response => response.json()).then(json => json.data)
  );

  const processData = (data) => Object.assign(data, {
    "tabelle": data.kreuztabelle.crossTableEntries
      .filter(team => (data[team.team.seasonTeamId] = team)) /* create teamIndex */
      .map(team => Object.assign(team, {games:0, wins:0, points:0, pointsOpponent:0, comments:[]}))
      .filter(homeTeam =>
        homeTeam.matches.filter(Boolean).flat().filter(match => 
          [homeTeam, data[match.guestTeam.seasonTeamId]].forEach((team, index, teams) => {
            [team.gamePoints, team.gamePointsOpponent] = (match.result || "0:0").split(':').map(Number).sort(() => -index);
            team.points += team.gamePoints;
            team.pointsOpponent += team.gamePointsOpponent;
            team.games += Number(Boolean(match.result));
            team.wins += Number(team.isWinner = (team.gamePoints > team.gamePointsOpponent));
            team.comments.push(`${match.kickoffDate} | ${teams[0].team.teamnameSmall} ${match.result || "__:__"} ${teams[1].team.teamnameSmall} ${team.isWinner ? ">> WIN" : ""}`);
          })
        )
      )
      .filter(team => Object.assign(team, {
        perc: Math.round(team.games ? team.wins / team.games * 100 : 0),
        pointsDiff: team.points - team.pointsOpponent
      }))
      .sort((teamA, teamB) => teamB.perc - teamA.perc || teamB.pointsDiff - teamA.pointsDiff)
  });

  const displayData = (data) => {
    document.querySelector("h1").innerHTML = `<a href='https://www.basketball-bund.net/static/#/liga/${data.ligaData.ligaId}/kreuztabelle'>${data.ligaData.liganame} - ${data.ligaData.seasonName}</a>`;
    data.tabelle.forEach((team, i) => {
      document.querySelector("table").innerHTML += `<tr data-clubId='${team.team.clubId}'>
        <th>${i + 1}</th>
        <td>${team.team.teamname}</td>
        <td>${team.games}</td>
        <td>${team.wins}</td>
        <td>${team.perc}%</td>
        <td title='${team.comments.sort().join("\n")}'>${("+"+team.pointsDiff).replace("+-", "-")} <span>(${team.points}:${team.pointsOpponent})</span></td>
      </tr>`;
    });
  };

  const handleError = (error) => {
    document.querySelector("table").outerHTML = "<h2 style='color:red'>ERROR occured</h2>";
    throw error;
  };

  getDataUrl()
    .then(loadData)
    .then(processData)
    .then(displayData)
    .catch(handleError);
</script>
<head>
<body>
  <h1>Loading...</h1>
  <table border='1'>
    <tr><th>#</th><th>Name</th><th>Games</th><th>Wins</th><th>Win%</th><th>Points</th></tr>
  </table>
  [<a href='https://github.com/madmaxmatze/code/tree/main/bball' target='_blank'>code</a>]
</body>
</html>
